<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>William L. Harrison, Ph.D : Case Study #1: Crossbar Switch</title>
        <meta name="description" content="Center for High Assurance Computing">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/css/syntax.css">
        <link rel="stylesheet" href="/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="/">William L. Harrison, Ph.D</a>
    <small>Center for High Assurance Computing</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <li><a href="/">Home</a></li>
    
        
        

        
            
                <li class="nav-header"></li>
            
            <li data-order="6"><a href="/doc/publications.html">Publications</a></li>
        
            
            <li data-order="6"><a href="/doc/sha256.html">Case Study #2: SHA-256</a></li>
        
            
            <li data-order="5"><a href="/doc/crossbarswitch.html">Case Study #1: Crossbar Switch</a></li>
        
            
            <li data-order="4"><a href="/doc/language-reference.html">Language Reference</a></li>
        
            
            <li data-order="3"><a href="/doc/quick-start.html">Quick Start</a></li>
        
            
            <li data-order="2"><a href="/doc/installing-rewire.html">Installing ReWire</a></li>
        
            
            <li data-order="1"><a href="/doc/introduction.html">Introduction</a></li>
        
    
        
        

        
    
        
        

        
    
        
        

        
    
        
        

        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Case Study #1: Crossbar Switch
        
    </h2>
</div>

<h3 id="whats-a-crossbar-switch">What’s a Crossbar Switch?</h3>

<p>To perform this exercise, I relied primarily on two sources to explain what a crossbar switch is; they are:</p>

<ul>
  <li><a href="https://en.wikipedia.org/wiki/Crossbar_switch">Wikipedia</a>, and</li>
  <li><a href="http://www.mathcs.emory.edu/~cheung/Courses/355/Syllabus/90-parallel/CrossBar.html">The Crossbar Switch</a>.</li>
</ul>

<p>Given these explanations, I generated a Haskell implementation of a crossbar switch like function (see <code class="highlighter-rouge">CrossbarSwitch.hs</code> below). Now, one could spend a lot of time trying to figure out if the code in <code class="highlighter-rouge">CrossbarSwitch.hs</code> is a crossbar switch, but for the purposes of learning ReWire, that issue is really beside the point. I recommend simply accepting <code class="highlighter-rouge">CrossbarSwitch.hs</code> as an input specification and don’t worry too much about what it actually models. The real point of this part of the tutorial is to see how to program in ReWire.</p>

<p>All the Haskell and ReWire code for this example can be found below:</p>

<ul>
  <li><a href="/assets/code/crossbar/ReWirePrelude.hs">ReWirePrelude.hs</a>: some standard definitions.</li>
  <li><a href="/assets/code/crossbar/CrossbarSwitch.hs">CrossbarSwitch.hs</a>: a Haskell specification of a crossbar switch.</li>
  <li><a href="/assets/code/crossbar/RWCrossbar.hs">RWCrossbar.hs</a>: the ReWire specification of a crossbar switch.</li>
  <li><a href="/assets/code/crossbar/RWC.vhd">RWC.vhd</a>: the VHDL code generated by the ReWire compiler.</li>
</ul>

<p>What follows is an explanation of this code. First we describe the ReWirePrelude, which is a collection of, more or less, standard definitions. Then, we consider the Haskell definition of a crossbar switch, written in monadic style. In the final and most important section, we transform the Haskell definition of the switch into proper ReWire. This is important because it gives you a practical introduction to the differences between Haskell and ReWire. There are a number of small differences between the Haskell code <code class="highlighter-rouge">CrossbarSwitch.hs</code> and the ReWire code <code class="highlighter-rouge">RWCrossbar.hs</code> that shed light on how to program in ReWire.</p>

<p>The usual mode of program development is to first write a version of the desired application in Haskell using the concepts described in the <a href="/doc/language-reference.html">Language Reference section</a>. The reasons to do this boil down to the GHC compiler being vastly more mature than the ReWire compiler, and so, for example, error messages are much more informative. Once all the kinks as it were are worked out in Haskell (e.g., getting something that typechecks, etc.), make a number of small tweeks to get your program into the ReWire subset of Haskell. This section of the tutorial introduces the reader to this mode of program development.</p>

<h3 id="rewire-prelude">"ReWire Prelude"</h3>

<p>In the same manner as the Glasgow Haskell Compiler and other Haskell implementations, we are compiling a list of standard definitions into a prelude file, <code class="highlighter-rouge">ReWirePrelude.hs</code>. This file is, in effect, a dirty snowball of definitions that we are accumulating with the intent of ultimately making it part of the standard ReWire implementation. For now, to use it, you must explicitly import it.</p>

<p><code class="highlighter-rouge">ReWirePrelude.hs</code> includes definitions for bits (<code class="highlighter-rouge">Bit</code>) and words of various sizes (e.g., <code class="highlighter-rouge">W8</code> and <code class="highlighter-rouge">W32</code>) as well as functions on those primitive types (e.g., <code class="highlighter-rouge">rotateR2</code>). The particular file we use can be found <a href="/assets/code/ReWirePrelude.hs">here</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">module</span> <span class="nn">ReWirePrelude</span> <span class="kr">where</span>

<span class="kr">data</span> <span class="kt">Bit</span> <span class="o">=</span> <span class="kt">Zero</span> <span class="o">|</span> <span class="kt">One</span>
<span class="kr">data</span> <span class="kt">W8</span>  <span class="o">=</span> <span class="kt">W8</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span>
<span class="kr">data</span> <span class="kt">W32</span> <span class="o">=</span> <span class="kt">W32</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span>
               <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span>
               <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span>
               <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span> <span class="kt">Bit</span>

<span class="n">rotateR2</span><span class="p">,</span><span class="n">rotateR6</span><span class="p">,</span><span class="n">rotateR7</span><span class="p">,</span><span class="n">rotateR11</span><span class="p">,</span><span class="n">rotateR13</span><span class="p">,</span><span class="n">rotateR17</span><span class="p">,</span><span class="n">rotateR18</span><span class="p">,</span><span class="n">rotateR19</span><span class="p">,</span><span class="n">rotateR22</span> <span class="o">::</span> <span class="kt">W32</span> <span class="o">-&gt;</span> <span class="kt">W32</span>
<span class="n">rotateR2</span> <span class="p">(</span><span class="kt">W32</span> <span class="n">b0</span> <span class="n">b1</span> <span class="n">b2</span> <span class="n">b3</span> <span class="n">b4</span> <span class="n">b5</span> <span class="n">b6</span> <span class="n">b7</span> <span class="n">b8</span> <span class="n">b9</span> <span class="n">b10</span> <span class="n">b11</span> <span class="n">b12</span> <span class="n">b13</span> <span class="n">b14</span> <span class="n">b15</span>
              <span class="n">b16</span> <span class="n">b17</span> <span class="n">b18</span> <span class="n">b19</span> <span class="n">b20</span> <span class="n">b21</span> <span class="n">b22</span> <span class="n">b23</span> <span class="n">b24</span> <span class="n">b25</span> <span class="n">b26</span> <span class="n">b27</span> <span class="n">b28</span> <span class="n">b29</span> <span class="n">b30</span> <span class="n">b31</span><span class="p">)</span>
           <span class="o">=</span> <span class="p">(</span><span class="kt">W32</span> <span class="n">b30</span> <span class="n">b31</span> <span class="n">b0</span> <span class="n">b1</span> <span class="n">b2</span> <span class="n">b3</span> <span class="n">b4</span> <span class="n">b5</span> <span class="n">b6</span> <span class="n">b7</span> <span class="n">b8</span> <span class="n">b9</span> <span class="n">b10</span> <span class="n">b11</span> <span class="n">b12</span> <span class="n">b13</span>
                  <span class="n">b14</span> <span class="n">b15</span> <span class="n">b16</span> <span class="n">b17</span> <span class="n">b18</span> <span class="n">b19</span> <span class="n">b20</span> <span class="n">b21</span> <span class="n">b22</span> <span class="n">b23</span> <span class="n">b24</span> <span class="n">b25</span> <span class="n">b26</span> <span class="n">b27</span> <span class="n">b28</span> <span class="n">b29</span><span class="p">)</span>

  <span class="o">...</span><span class="n">stuff</span> <span class="n">deleted</span><span class="o">...</span>
</code></pre>
</div>

<h3 id="crossbar-switch-in-haskell">Crossbar Switch in Haskell</h3>

<p>What follows is a crossbar switch function written in Haskell. We will take this as an input specification, by which we mean that it is not terribly important to actually understand what the <code class="highlighter-rouge">crossbar</code> function is calculating. Rather, what is interesting is what must change in this specification to transform it into a proper ReWire specification.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">module</span> <span class="nn">CrossbarSwitch</span> <span class="kr">where</span>

<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Resumption.Reactive</span>

<span class="kr">import</span> <span class="nn">ReWirePrelude</span>

<span class="n">switch</span> <span class="o">::</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="n">switch</span> <span class="n">x</span> <span class="n">y</span> <span class="kt">True</span>  <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
<span class="n">switch</span> <span class="n">x</span> <span class="n">y</span> <span class="kt">False</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Maybe4</span> <span class="o">=</span> <span class="kt">Maybe4</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">Bool16</span> <span class="o">=</span> <span class="p">(</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">)</span>

<span class="n">crossbar</span> <span class="o">::</span> <span class="kt">Maybe4</span> <span class="o">-&gt;</span> <span class="kt">Bool16</span> <span class="o">-&gt;</span> <span class="kt">Maybe4</span> 
<span class="n">crossbar</span> <span class="p">(</span><span class="kt">Maybe4</span> <span class="n">x10</span> <span class="n">x20</span> <span class="n">x30</span> <span class="n">x40</span><span class="p">)</span> <span class="p">(</span><span class="n">c11</span><span class="p">,</span><span class="n">c12</span><span class="p">,</span><span class="n">c13</span><span class="p">,</span><span class="n">c14</span><span class="p">,</span><span class="n">c21</span><span class="p">,</span><span class="n">c22</span><span class="p">,</span><span class="n">c23</span><span class="p">,</span><span class="n">c24</span><span class="p">,</span><span class="n">c31</span><span class="p">,</span><span class="n">c32</span><span class="p">,</span><span class="n">c33</span><span class="p">,</span><span class="n">c34</span><span class="p">,</span><span class="n">c41</span><span class="p">,</span><span class="n">c42</span><span class="p">,</span><span class="n">c43</span><span class="p">,</span><span class="n">c44</span><span class="p">)</span>
   <span class="o">=</span> <span class="kr">let</span>
          <span class="p">(</span><span class="n">x11</span><span class="p">,</span><span class="n">y10</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x10</span> <span class="n">y11</span> <span class="n">c11</span>
          <span class="p">(</span><span class="n">x12</span><span class="p">,</span><span class="n">y20</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x11</span> <span class="n">y12</span> <span class="n">c12</span>
          <span class="p">(</span><span class="n">x13</span><span class="p">,</span><span class="n">y30</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x12</span> <span class="n">y13</span> <span class="n">c13</span>
          <span class="p">(</span><span class="n">x14</span><span class="p">,</span><span class="n">y40</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x13</span> <span class="n">y14</span> <span class="n">c14</span>
          <span class="p">(</span><span class="n">x21</span><span class="p">,</span><span class="n">y11</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x20</span> <span class="n">y21</span> <span class="n">c21</span>
          <span class="p">(</span><span class="n">x22</span><span class="p">,</span><span class="n">y12</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x21</span> <span class="n">y22</span> <span class="n">c22</span>
          <span class="p">(</span><span class="n">x23</span><span class="p">,</span><span class="n">y13</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x22</span> <span class="n">y23</span> <span class="n">c23</span>
          <span class="p">(</span><span class="n">x24</span><span class="p">,</span><span class="n">y14</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x23</span> <span class="n">y24</span> <span class="n">c24</span>
          <span class="p">(</span><span class="n">x31</span><span class="p">,</span><span class="n">y21</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x30</span> <span class="n">y31</span> <span class="n">c31</span>
          <span class="p">(</span><span class="n">x32</span><span class="p">,</span><span class="n">y22</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x31</span> <span class="n">y32</span> <span class="n">c32</span>
          <span class="p">(</span><span class="n">x33</span><span class="p">,</span><span class="n">y23</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x32</span> <span class="n">y33</span> <span class="n">c33</span>
          <span class="p">(</span><span class="n">x34</span><span class="p">,</span><span class="n">y24</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x33</span> <span class="n">y34</span> <span class="n">c34</span>
          <span class="p">(</span><span class="n">x41</span><span class="p">,</span><span class="n">y31</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x40</span> <span class="kt">Nothing</span> <span class="n">c41</span>
          <span class="p">(</span><span class="n">x42</span><span class="p">,</span><span class="n">y32</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x41</span> <span class="kt">Nothing</span> <span class="n">c42</span>
          <span class="p">(</span><span class="n">x43</span><span class="p">,</span><span class="n">y33</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x42</span> <span class="kt">Nothing</span> <span class="n">c43</span>
          <span class="p">(</span><span class="n">x44</span><span class="p">,</span><span class="n">y34</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x43</span> <span class="kt">Nothing</span> <span class="n">c44</span>
     <span class="kr">in</span>
       <span class="kt">Maybe4</span> <span class="n">y10</span> <span class="n">y20</span> <span class="n">y30</span> <span class="n">y40</span>

<span class="kr">data</span> <span class="kt">Inp</span> <span class="o">=</span> <span class="kt">Inp</span> <span class="kt">Maybe4</span> <span class="kt">Bool16</span> <span class="o">|</span> <span class="kt">NoInput</span>
            
<span class="kr">data</span> <span class="kt">Out</span> <span class="o">=</span> <span class="kt">Out</span> <span class="kt">Maybe4</span> <span class="o">|</span> <span class="kt">Nix</span>

<span class="n">devcrossbar</span> <span class="o">::</span> <span class="kt">ReacT</span> <span class="kt">Inp</span> <span class="kt">Out</span> <span class="kt">Identity</span> <span class="nb">()</span>
<span class="n">devcrossbar</span> <span class="o">=</span> <span class="n">signal</span> <span class="kt">Nix</span> <span class="o">&gt;&gt;=</span> <span class="n">dev</span>

<span class="n">dev</span> <span class="o">::</span> <span class="kt">Inp</span> <span class="o">-&gt;</span> <span class="kt">ReacT</span> <span class="kt">Inp</span> <span class="kt">Out</span> <span class="kt">Identity</span> <span class="nb">()</span>
<span class="n">dev</span> <span class="p">(</span><span class="kt">Inp</span> <span class="n">m4</span> <span class="n">b16</span><span class="p">)</span> <span class="o">=</span> <span class="n">signal</span> <span class="p">(</span><span class="kt">Out</span> <span class="p">(</span><span class="n">crossbar</span> <span class="n">m4</span> <span class="n">b16</span><span class="p">))</span> <span class="o">&gt;&gt;=</span> <span class="n">dev</span>
<span class="n">dev</span> <span class="kt">NoInput</span>      <span class="o">=</span> <span class="n">signal</span> <span class="kt">Nix</span> <span class="o">&gt;&gt;=</span> <span class="n">dev</span>
</code></pre>
</div>

<h3 id="crossbar-switch-in-rewire">Crossbar Switch in ReWire</h3>

<p>This section considers the ReWire version of the crossbar switch. The whole code is available <a href="/assets/code/RWCrossbar.hs">here</a>. These two implementations are <em>almost</em> the same, but there are differences. We will go through the code in detail to highlight the differences.</p>

<p>Here we have commented out the module and import declarations, except for the <code class="highlighter-rouge">ReWirePrelude</code>. The main ReWire file does not belong in a <code class="highlighter-rouge">module</code>. Note that the monad definitions from <code class="highlighter-rouge">Control.Monad</code> are built-in to ReWire, and so, they should not be imported.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">{- 
module CrossbarSwitch where

import Control.Monad.Identity
import Control.Monad.State
import Control.Monad.Resumption.Reactive

type I = Identity
-}</span>

<span class="kr">import</span> <span class="nn">ReWirePrelude</span>
</code></pre>
</div>

<p>Note that the <code class="highlighter-rouge">switch</code> function has polymorphic type below. ReWire does not allow polymorphically typed expressions, and so, for that reason, we use an <code class="highlighter-rouge">INLINE</code> directive. This directive informs the ReWire frontend to inline that function wherever it occurs. This has the effect of eliminating the polymorphic function. An alternative would be to simply rewrite the type declaration of <code class="highlighter-rouge">switch</code> so that it had a simple (i.e., variable free) type. Note also that the <code class="highlighter-rouge">Maybe4</code> declaration is written with no free variables; i.e., <code class="highlighter-rouge">Maybe4</code> isn’t polymorphic either.</p>

<p>It is worth emphasizing that each function declaration in ReWire must have an accompanying type declaration.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">switch</span> <span class="o">::</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="cp">{-# INLINE switch #-}</span>
<span class="n">switch</span> <span class="n">x</span> <span class="n">y</span> <span class="kt">True</span>  <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
<span class="n">switch</span> <span class="n">x</span> <span class="n">y</span> <span class="kt">False</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">Maybe4</span> <span class="o">=</span> <span class="kt">Maybe4</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span> <span class="p">(</span><span class="kt">Maybe</span> <span class="kt">W8</span><span class="p">)</span>
</code></pre>
</div>

<p>The code for <code class="highlighter-rouge">crossbar</code> below has several changes. For one, it is no longer declared with a <code class="highlighter-rouge">let</code> declaration, but rather uses an equivalent <code class="highlighter-rouge">where</code> formulation. Semantically, <code class="highlighter-rouge">where</code> and <code class="highlighter-rouge">let</code> are equivalent; that is, <code class="highlighter-rouge">let &lt;binding-group&gt; in e</code> is equvalent to <code class="highlighter-rouge">e where &lt;binding-group&gt;</code>. But, as of this writing, <code class="highlighter-rouge">let</code> has not been implemented in the ReWire compiler as yet (it is on a lengthy to-do list of simple extensions). There is another slightly more substantial difference. The clauses in the <code class="highlighter-rouge">where</code> declaration have been rearranged in order of dependency. These binding clauses are processed in-order (in the manner of, say, OCaml) rather than as a group (as in Haskell). This is a ReWire bug/feature which also appears on the aforementioned to-do list. Note that we have also dispensed with the <code class="highlighter-rouge">type</code> synonym <code class="highlighter-rouge">Bool16</code>. Type synonyms are on our to-do list.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">crossbar</span> <span class="o">::</span> <span class="kt">Maybe4</span>                                                                            <span class="o">-&gt;</span>
            <span class="p">(</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="kt">Maybe4</span> 
<span class="n">crossbar</span> <span class="p">(</span><span class="kt">Maybe4</span> <span class="n">x10</span> <span class="n">x20</span> <span class="n">x30</span> <span class="n">x40</span><span class="p">)</span> <span class="p">(</span><span class="n">c11</span><span class="p">,</span><span class="n">c12</span><span class="p">,</span><span class="n">c13</span><span class="p">,</span><span class="n">c14</span><span class="p">,</span><span class="n">c21</span><span class="p">,</span><span class="n">c22</span><span class="p">,</span><span class="n">c23</span><span class="p">,</span><span class="n">c24</span><span class="p">,</span><span class="n">c31</span><span class="p">,</span><span class="n">c32</span><span class="p">,</span><span class="n">c33</span><span class="p">,</span><span class="n">c34</span><span class="p">,</span><span class="n">c41</span><span class="p">,</span><span class="n">c42</span><span class="p">,</span><span class="n">c43</span><span class="p">,</span><span class="n">c44</span><span class="p">)</span>
   <span class="o">=</span> <span class="kt">Maybe4</span> <span class="n">y10</span> <span class="n">y20</span> <span class="n">y30</span> <span class="n">y40</span>
        <span class="kr">where</span>
          <span class="p">(</span><span class="n">x41</span><span class="p">,</span><span class="n">y31</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x40</span> <span class="kt">Nothing</span> <span class="n">c41</span>
          <span class="p">(</span><span class="n">x31</span><span class="p">,</span><span class="n">y21</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x30</span> <span class="n">y31</span> <span class="n">c31</span>
          <span class="p">(</span><span class="n">x21</span><span class="p">,</span><span class="n">y11</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x20</span> <span class="n">y21</span> <span class="n">c21</span>
          <span class="p">(</span><span class="n">x42</span><span class="p">,</span><span class="n">y32</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x41</span> <span class="kt">Nothing</span> <span class="n">c42</span>
          <span class="p">(</span><span class="n">x32</span><span class="p">,</span><span class="n">y22</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x31</span> <span class="n">y32</span> <span class="n">c32</span>
          <span class="p">(</span><span class="n">x22</span><span class="p">,</span><span class="n">y12</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x21</span> <span class="n">y22</span> <span class="n">c22</span>
          <span class="p">(</span><span class="n">x11</span><span class="p">,</span><span class="n">y10</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x10</span> <span class="n">y11</span> <span class="n">c11</span>
          <span class="p">(</span><span class="n">x12</span><span class="p">,</span><span class="n">y20</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x11</span> <span class="n">y12</span> <span class="n">c12</span>
          <span class="p">(</span><span class="n">x43</span><span class="p">,</span><span class="n">y33</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x42</span> <span class="kt">Nothing</span> <span class="n">c43</span>
          <span class="p">(</span><span class="n">x33</span><span class="p">,</span><span class="n">y23</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x32</span> <span class="n">y33</span> <span class="n">c33</span>
          <span class="p">(</span><span class="n">x23</span><span class="p">,</span><span class="n">y13</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x22</span> <span class="n">y23</span> <span class="n">c23</span>
          <span class="p">(</span><span class="n">x13</span><span class="p">,</span><span class="n">y30</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x12</span> <span class="n">y13</span> <span class="n">c13</span>
          <span class="p">(</span><span class="n">x44</span><span class="p">,</span><span class="n">y34</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x43</span> <span class="kt">Nothing</span> <span class="n">c44</span>
          <span class="p">(</span><span class="n">x34</span><span class="p">,</span><span class="n">y24</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x33</span> <span class="n">y34</span> <span class="n">c34</span>
          <span class="p">(</span><span class="n">x24</span><span class="p">,</span><span class="n">y14</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x23</span> <span class="n">y24</span> <span class="n">c24</span>
          <span class="p">(</span><span class="n">x14</span><span class="p">,</span><span class="n">y40</span><span class="p">)</span> <span class="o">=</span> <span class="n">switch</span> <span class="n">x13</span> <span class="n">y14</span> <span class="n">c14</span>
</code></pre>
</div>

<p>Below are the input and output types for the device, <code class="highlighter-rouge">Inp</code> and <code class="highlighter-rouge">Out</code>. One thing that stands out style-wise when compared to Haskell is that we don’t use a <code class="highlighter-rouge">type</code> synonym for the long tuple of <code class="highlighter-rouge">Bool</code>s. In Haskell, one would typically write something like <code class="highlighter-rouge">type Bool16 = (Bool,...,Bool)</code> just for syntactic convenience. As it stands, <code class="highlighter-rouge">type</code> synonyms are unimplemented in ReWire. This is, again, on the aforementioned to-do list of simple extensions to ReWire.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">data</span> <span class="kt">Inp</span> <span class="o">=</span> <span class="kt">Inp</span> <span class="kt">Maybe4</span>                                                                            
               <span class="p">(</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">,</span><span class="kt">Bool</span><span class="p">)</span>
         <span class="o">|</span> <span class="kt">NoInput</span>
            
<span class="kr">data</span> <span class="kt">Out</span> <span class="o">=</span> <span class="kt">Out</span> <span class="kt">Maybe4</span> <span class="o">|</span> <span class="kt">Nix</span>
</code></pre>
</div>

<p>Below is the device declaration. The built-in identity monad in ReWire is written <code class="highlighter-rouge">I</code> (rather than <code class="highlighter-rouge">Identity</code> that was imported from <code class="highlighter-rouge">Control.Monad</code> in the Haskell version). Note that the <code class="highlighter-rouge">dev</code> has been replaced by the semantically equivalent <code class="highlighter-rouge">\ i -&gt; dev i</code> below. This is because ReWire is a 1st-order language and you cannot pass the function <code class="highlighter-rouge">dev</code> to the other function <code class="highlighter-rouge">&gt;&gt;=</code>. It is a focus of current research to extend ReWire to higher-order.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">devcrossbar</span> <span class="o">::</span> <span class="kt">ReT</span> <span class="kt">Inp</span> <span class="kt">Out</span> <span class="kt">I</span> <span class="nb">()</span>
<span class="n">devcrossbar</span> <span class="o">=</span> <span class="n">signal</span> <span class="kt">Nix</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">dev</span> <span class="n">i</span>

<span class="n">dev</span> <span class="o">::</span> <span class="kt">Inp</span> <span class="o">-&gt;</span> <span class="kt">ReT</span> <span class="kt">Inp</span> <span class="kt">Out</span> <span class="kt">I</span> <span class="nb">()</span>
<span class="n">dev</span> <span class="p">(</span><span class="kt">Inp</span> <span class="n">m4</span> <span class="n">b16</span><span class="p">)</span> <span class="o">=</span> <span class="n">signal</span> <span class="p">(</span><span class="kt">Out</span> <span class="p">(</span><span class="n">crossbar</span> <span class="n">m4</span> <span class="n">b16</span><span class="p">))</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">dev</span> <span class="n">i</span>
<span class="n">dev</span> <span class="kt">NoInput</span>      <span class="o">=</span> <span class="n">signal</span> <span class="kt">Nix</span> <span class="o">&gt;&gt;=</span> <span class="nf">\</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">dev</span> <span class="n">i</span>
</code></pre>
</div>

<p>Last, but not least, is that every ReWire specification must contain a <code class="highlighter-rouge">start</code> declaration. The <code class="highlighter-rouge">start</code> symbol must have type <code class="highlighter-rouge">ReT Inp Out I ()</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">start</span> <span class="o">::</span> <span class="kt">ReT</span> <span class="kt">Inp</span> <span class="kt">Out</span> <span class="kt">I</span> <span class="nb">()</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">devcrossbar</span>
</code></pre>
</div>

<h3 id="compiling-with-the-rewire-compiler">Compiling with the ReWire Compiler</h3>

<p>Once the ReWire specification is complete, we can compile with the ReWire compiler <code class="highlighter-rouge">rwc</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>bill$ rwc RWCrossbar.hs -o RWC.vhd
bill$ ls -l RWC.vhd
-rwxr-xr-x  1 bill  staff  61024 Jun 14 14:11 RWC.vhd
</code></pre>
</div>

<p>Note that, depending how successfully one’s translation into ReWire is, one may receive error messages fro the ReWire compiler. These are <em>improving</em>, although there is admittedly much room for improvement as of this writing.</p>

<h3 id="synthesis">Synthesis</h3>

<p>Finally, one may synthesize the generated VHDL (here, <code class="highlighter-rouge">RWC.vhd</code>) using an off-the-shelf tool like Vivado or ISE. Here we use Xilinx ISE in this partial screenshot of the successful synthesis:</p>

<p><img src="/images/ss17.png" style="display: block; margin: 0 auto; max-width: 100%;" alt="Screenshot" /></p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/mu-chaco/ReWire">William L. Harrison, Ph.D</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
